# TestTask3

## ТЗ
Разработать два сервиса:
- кошелек-обменник с авторизацией (**gw-currency-wallet**)
- сервис exchanger для получения курсов валют (**gw-exchanger**)

<div align="center">
  <picture>
    <img src="img.png" alt="scheme dc-smart-light" style="width: 60%; margin-top: 5px; margin-bottom: 1px;">
  </picture>
</div>

Сервисы должны общаться между собой по grpc

### 1. Создание сервиса exchanger для получения курсов валют (gw-exchanger)
В качестве базы использовать PostgreSql (но описать интерфейс, чтобы можно было поменять на любую БД).
Сами значения курса валют сервис должен получать из БД.
Сервис по grpc должен обрабатывать запросы на получение курса валют.
В качестве валют поддерживаются **USD, RUB, EUR**.

Сервис должен иметь продвинутое логирование + читать переменные окружения из config.env (для локального запуска)

---

### 2. Разработка микросервиса для управления кошельком и обмена валют (gw-currency-wallet)
Микросервис должен поддерживать регистрацию и авторизацию пользователей, пополнение счета, вывод средств,
получение курсов валют и обмен валют. В качестве базы данных используется PostgreSQL.
Для взаимодействия с внешним сервисом курсов валют используется gRPC.

Стек технологий: _Gin (или другой HTTP-фреймворк), JWT для авторизации, gRPC для получения курсов валют и обмена_

API должен быть RESTful.

1. Регистрация пользователя
2. Авторизация пользователя
3. Получение баланса пользователя
4. Пополнение счета
5. Вывод средств 
6. Получение курса валют
7. Обмен валют


▎Описание

Курс валют осуществляется по данным сервиса exchange (если в течении небольшого времени был запрос от клиента курса валют (**/api/v1/exchange**) до обмена, то
брать курс из кэша, если же запроса курса валют не было или он запрашивался слишком давно, то нужно осуществить gRPC-вызов к внешнему сервису, который предоставляет актуальные курсы валют)
Проверяется наличие средств для обмена, и обновляется баланс пользователя.

Также нужно учесть:
1. Безопасность: Все запросы должны быть защищены JWT-токенами.
2. Производительность: Время отклика сервиса не должно превышать 200 мс для большинства операций.
3. Логирование: Все операции должны логироваться для дальнейшего анализа и отладки.
4. Тестирование: Необходимо написать юнит-тесты для всех основных функций.
5. Документация: Создать документацию API с использованием Swagger или аналогичного инструмента.

Сервис должен иметь продвинутое логирование + читать переменные окружения из config.env (для локального запуска)

Полное тз в task.md

## Запуск
- создать файл .env (см. env.sample)
- docker compose up --build

swagger сервиса wallet по адресу localhost:5050/swagger (только если ENV=Development) 

для дебага отдельного сервиса можно поднять в docker-compose всё остальное и запустить его с переменной окружения CONFIG_PATH=configs/config.env

запуск вместе с Consul:
docker-compose -f docker-compose.yml -f docker-compose.consul.yml up --build

## Pitfalls

- dns resolving идёт 8 секунд для первого grpc запроса (wtf?). Но если в docker-compose ```EXCHANGER_URL: exchanger:${EXCHANGER_PORT}``` поменять на ```EXCHANGER_URL: 0.0.0.0:${EXCHANGER_PORT}```, то всё норм
- через consul наоборот - резолвит моментально